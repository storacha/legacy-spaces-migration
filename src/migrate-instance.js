#!/usr/bin/env node
/**
 * Instance Migration Script
 * 
 * Wrapper around migrate.js to process a specific instance's customer list.
 * generated by setup-distribution.js
 * 
 * Usage:
 *   node src/migrate-instance.js --instance 1
 */
import { parseArgs } from 'node:util'
import { readFile, writeFile, unlink } from 'fs/promises'
import path from 'path'
import { spawn } from 'child_process'
import { config } from './config.js'

const DISTRIBUTION_DIR = 'migration-state'

async function main() {
  const { values } = parseArgs({
    options: {
      instance: {
        type: 'string',
        short: 'i',
        description: 'Instance ID to process',
      },
      concurrency: {
        type: 'string',
        short: 'c',
        default: '10',
        description: 'Concurrency level',
      },
      'verify-only': {
        type: 'boolean',
        default: false,
        description: 'Verify migration status without making changes',
      }
    },
  })

  if (!values.instance) {
    console.error('Error: --instance required')
    process.exit(1)
  }

  const instanceId = values.instance
  const concurrency = values.concurrency
  const verifyOnly = values['verify-only']
  const env = config.environment
  
  // Read instance file
  const instanceFile = path.join(DISTRIBUTION_DIR, `instance-${instanceId}-customers-${env}.json`)
  console.log(`Reading instance configuration from ${instanceFile}...`)
  
  let instanceData
  try {
    const content = await readFile(instanceFile, 'utf-8')
    instanceData = JSON.parse(content)
  } catch (error) {
    console.error(`Error reading instance file: ${/** @type {Error} */ (error).message}`)
    console.error(`Did you run 'node src/setup-distribution.js --instances <N>' first?`)
    process.exit(1)
  }

  console.log(`Instance ${instanceId}: Found ${instanceData.customers.length} customers to process`)
  
  // Create temp flat file for migrate.js
  const tempFile = path.join(DISTRIBUTION_DIR, `temp-instance-${instanceId}-customers.json`)
  await writeFile(tempFile, JSON.stringify(instanceData.customers, null, 2))
  
  console.log(`Created temporary customer list at ${tempFile}`)
  console.log(`Starting migration with concurrency ${concurrency}...`)
  console.log('='.repeat(50))
  console.log()

  // Build args for migrate.js
  const migrateArgs = [
    'src/migrate.js',
    '--customers-file', tempFile,
    '--concurrency', concurrency,
    '--instance-id', instanceId
  ]
  
  if (verifyOnly) {
    migrateArgs.push('--verify-only')
  }

  // Spawn migrate.js
  const migrateProcess = spawn('node', migrateArgs, {
    stdio: 'inherit',
    env: { ...process.env }
  })

  migrateProcess.on('close', async (code) => {
    // Cleanup temp file
    try {
      await unlink(tempFile)
    } catch (e) {
      // Ignore cleanup error
    }
    
    if (code === 0) {
      console.log(`\nInstance ${instanceId} migration completed successfully.`)
    } else {
      console.error(`\nInstance ${instanceId} migration failed with exit code ${code}.`)
    }
    process.exit(code)
  })
}

main().catch(error => {
  console.error('Fatal error:', error)
  process.exit(1)
})
